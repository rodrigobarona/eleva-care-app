# Drizzle Migrations

This directory contains database migrations managed by Drizzle ORM.

## Directory Structure

- `/migrations/` - Automatic migrations generated by Drizzle
- `/migrations-manual/` - Manual SQL migrations for special operations

## Current Schema

The project uses `schema.ts` which contains all tables for WorkOS authentication.

**Note:** `schema-clerk-legacy.ts` is preserved for future data migration scripts only.

### Main Tables

- `organizations` - User organizations (org-per-user model)
- `users` - User profiles and settings
- `user_org_memberships` - User-organization relationships with roles
- `events` - Expert services/offerings
- `schedules` - Expert availability schedules
- `meetings` - Appointments between users and experts
- `subscription_plans` - Organization subscription plans
- `expert_applications` - Expert application system
- `audit_logs` - Security audit trail

## Migration History

### Automatic Migrations (Applied ✅)

All migrations in `/migrations/` (0000-0016) have been applied to production.

**Important:** Do NOT delete these migrations as they represent the database history.

### Manual Migrations

Manual migrations are optional SQL scripts for:

- **RLS Policies** - Row-Level Security (currently NOT in use)
- **Data Migrations** - One-time data transformations
- **Schema Fixes** - Manual schema adjustments

#### RLS Migrations (Currently NOT Used)

- `001_enable_rls.sql` - Neon Auth-based RLS (uses JWT)
- `001_enable_rls_standard.sql` - Standard RLS (uses SET LOCAL)
- `002_phase3_enable_rls.sql` - Phase 3 RLS policies
- `003_enable_rls_missing_tables.sql` - Additional table RLS
- `004_subscription_plans_rls.sql` - Subscription plans RLS

**Status:** These files are preserved for future use but NOT currently applied.

**Why not RLS?** The application uses application-level authorization which is:

- Simpler to debug
- More flexible
- Easier to test
- Sufficient for current scale

**Future:** When implementing RLS, use the standard approach (001_enable_rls_standard.sql) for better portability.

#### Data Migrations (Applied ✅)

- `002_add_guest_user_fields.sql` - Guest user support
- `010_migrate_preferences_to_users.sql` - Merge user preferences
- `011_cleanup_user_preferences.sql` - Remove old preferences table
- `012_add_google_oauth_columns.sql` - Google Calendar integration

## Running Migrations

### Automatic Migrations

```bash
# Generate new migration
bun db:generate

# Apply pending migrations
bun db:migrate

# View database in Drizzle Studio
bun db:studio
```

### Manual Migrations

```bash
# Apply a manual migration
psql $DATABASE_URL -f drizzle/migrations-manual/xxx.sql

# Rollback (if supported)
psql $DATABASE_URL -f drizzle/migrations-manual/xxx_rollback.sql
```

## Best Practices

1. **Never delete applied migrations** - They represent history
2. **Always generate migrations** - Don't edit migration files directly
3. **Test migrations locally first** - Use `DATABASE_DEV_URL`
4. **Backup before manual migrations** - Use `pg_dump`
5. **Document manual migrations** - Add comments in SQL files

## Schema Changes Workflow

1. Edit `drizzle/schema.ts`
2. Run `bun db:generate` to create migration
3. Review generated SQL in `migrations/`
4. Run `bun db:migrate` to apply
5. Commit both schema and migration files

## Troubleshooting

### Migration Failed

```bash
# Check current schema version
psql $DATABASE_URL -c "SELECT * FROM drizzle_migrations;"

# Rollback (if supported)
psql $DATABASE_URL -c "DELETE FROM drizzle_migrations WHERE version = 'xxxx';"

# Reapply
pnpm db:migrate
```

### Schema Out of Sync

```bash
# Generate a fix migration
pnpm db:generate

# Or use push for development (⚠️ not for production)
pnpm db:push
```

## Production Deployment

1. **Test locally** with `DATABASE_DEV_URL`
2. **Backup production** database
3. **Apply to staging** first
4. **Monitor for errors**
5. **Apply to production** during maintenance window
6. **Verify** with health checks

## Notes

- All timestamps are in UTC
- All IDs use UUIDs (v4)
- Soft deletes are preferred (use `deleted_at`)
- Foreign keys use `CASCADE` carefully
- Indexes are created for all foreign keys

---

**Last Updated:** December 16, 2025  
**Current Schema Version:** 0017 (audit consolidation)  
**Database:** PostgreSQL 15+ (Neon)  
**ORM:** Drizzle ORM  
**Runtime:** Bun 1.x
