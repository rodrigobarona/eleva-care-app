/**
 * Neon Database Client with Automatic RLS
 *
 * Provides Drizzle ORM client instances with automatic Row-Level Security (RLS)
 * enforcement via Neon Auth + WorkOS JWT integration.
 *
 * Key Features:
 * - Automatic JWT validation via Neon Auth
 * - `auth.user_id()` extracts WorkOS user ID from JWT
 * - No manual RLS context setting required
 * - Connection pooling via Neon HTTP
 *
 * Architecture:
 * ```
 * WorkOS JWT → Neon Auth (validates via JWKS) → auth.user_id() → RLS policies
 * ```
 *
 * @see https://neon.tech/docs/guides/neon-auth
 * @see https://neon.tech/docs/guides/neon-rls-workos
 */

'use server';

import * as schema from '@/drizzle/schema-workos';
import { requireAuth } from '@/lib/auth/workos-session';
import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

/**
 * Neon Database Client with Automatic RLS
 *
 * Provides Drizzle ORM client instances with automatic Row-Level Security (RLS)
 * enforcement via Neon Auth + WorkOS JWT integration.
 *
 * Key Features:
 * - Automatic JWT validation via Neon Auth
 * - `auth.user_id()` extracts WorkOS user ID from JWT
 * - No manual RLS context setting required
 * - Connection pooling via Neon HTTP
 *
 * Architecture:
 * ```
 * WorkOS JWT → Neon Auth (validates via JWKS) → auth.user_id() → RLS policies
 * ```
 *
 * @see https://neon.tech/docs/guides/neon-auth
 * @see https://neon.tech/docs/guides/neon-rls-workos
 */

/**
 * Get Drizzle client with RLS enforcement via JWT
 *
 * Pass the WorkOS access token as authToken - Neon Auth will:
 * 1. Validate JWT via WorkOS JWKS
 * 2. Extract user_id claim
 * 3. Make it available as `auth.user_id()` in SQL
 * 4. RLS policies automatically filter data
 *
 * @param jwtToken - WorkOS access token from session
 * @returns Drizzle database instance with RLS enabled
 *
 * @example
 * ```typescript
 * const session = await requireAuth();
 * const db = getDrizzleClient(session.accessToken);
 *
 * // Query automatically filtered by RLS
 * const events = await db.select().from(EventsTable);
 * // ↑ Only returns events from user's orgs
 * ```
 */
export function getDrizzleClient(jwtToken: string) {
  // Neon HTTP client with JWT authentication
  const sql = neon(process.env.DATABASE_URL!, {
    authToken: jwtToken, // <-- JWT passed here, validated by Neon Auth
    fetchOptions: {
      cache: 'no-store', // Disable caching for auth queries
    },
  });

  return drizzle(sql, { schema });
}

/**
 * Get organization-scoped database client
 *
 * Automatically uses JWT from current session.
 * RLS policies enforce org-level data access.
 *
 * **This is the recommended way to query the database in server actions.**
 *
 * @returns Drizzle database instance with automatic RLS
 * @throws Error if user not authenticated
 *
 * @example
 * ```typescript
 * // server/actions/events.ts
 * 'use server';
 *
 * export async function getUserEvents() {
 *   const db = await getOrgScopedDb();
 *
 *   // RLS automatically filters by user's org memberships
 *   const events = await db.select().from(EventsTable);
 *
 *   return events;
 * }
 * ```
 */
export async function getOrgScopedDb() {
  const session = await requireAuth();

  // JWT automatically validated by Neon Auth
  return getDrizzleClient(session.accessToken);
}

/**
 * Get admin database client (BYPASS RLS)
 *
 * ⚠️ **WARNING**: This bypasses RLS policies!
 *
 * Only use for:
 * - Data migrations
 * - Admin operations
 * - System tasks
 *
 * **NEVER use in production API routes or user-facing actions!**
 *
 * @returns Drizzle database instance without RLS
 *
 * @example
 * ```typescript
 * // scripts/migrate-data.ts
 * async function migrateUsers() {
 *   const db = await getAdminDb();
 *
 *   // Admin access - no RLS filtering
 *   const allUsers = await db.select().from(UsersTable);
 *
 *   // ... migration logic
 * }
 * ```
 */
export async function getAdminDb() {
  // Prevent accidental use in production
  if (process.env.NODE_ENV === 'production') {
    // Allow only for specific admin operations
    // You might want to add additional checks here
    console.warn('⚠️  Admin DB access in production - ensure this is intentional!');
  }

  const sql = neon(process.env.DATABASE_URL!);
  return drizzle(sql, { schema });
}

/**
 * Get database client for development/testing
 *
 * Uses development database URL.
 * Useful for running migrations and testing.
 *
 * @returns Drizzle database instance (dev DB)
 */
export function getDevDb() {
  const sql = neon(process.env.DATABASE_DEV_URL || process.env.DATABASE_URL!);
  return drizzle(sql, { schema });
}

/**
 * Get legacy database client (read-only)
 *
 * For accessing legacy Clerk data during migration.
 *
 * @returns Drizzle database instance (legacy DB)
 */
export function getLegacyDb() {
  const sql = neon(process.env.DATABASE_URL_LEGACY!);
  return drizzle(sql); // No schema - different structure
}
