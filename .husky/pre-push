echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing to main or develop
branch=$(git branch --show-current)

if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
  echo "âš ï¸  Pushing to $branch - running full test suite..."
  
  # Run all critical tests before pushing to main/develop
  echo "ğŸ§ª Running unit tests..."
  pnpm test:unit --passWithNoTests
  
  echo "ğŸª Running webhook tests..."
  pnpm test tests/api/webhooks/ --passWithNoTests
  
  echo "ğŸ”— Running integration tests..."
  pnpm test:integration --passWithNoTests
  
  echo "ğŸ—ï¸ Testing build..."
  pnpm build
  
else
  echo "ğŸ“¦ Running focused tests for feature branch..."
  
  # For feature branches, run tests related to changed files
  changed_files=$(git diff origin/$branch..HEAD --name-only | grep -E '\.(ts|tsx)$' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
  
  if [ -n "$changed_files" ]; then
    echo "ğŸ” Found changed TypeScript files, running related tests..."
    pnpm test --findRelatedTests $changed_files --passWithNoTests
  else
    echo "ğŸ“ No TypeScript files changed, running basic test check..."
    pnpm test --passWithNoTests --testPathPattern="__tests__" || echo "â„¹ï¸  No matching tests found"
  fi
fi

echo "âœ… Pre-push checks completed!"