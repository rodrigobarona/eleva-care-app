echo "🚀 Running pre-push checks..."

# Check if we're on a feature branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ $BRANCH == feat/* || $BRANCH == fix/* || $BRANCH == chore/* ]]; then
  echo "📦 Running focused tests for feature branch..."
  
  # Get files changed compared to main/master
  MAIN_BRANCH="main"
  if ! git rev-parse --verify refs/remotes/origin/main >/dev/null 2>&1; then
    MAIN_BRANCH="master"
  fi
  
  # Find TypeScript files that have changed
  if git diff --name-only origin/$MAIN_BRANCH...HEAD | grep -E '\.(ts|tsx)$' > /dev/null; then
    FILES=$(git diff --name-only origin/$MAIN_BRANCH...HEAD | grep -E '\.(ts|tsx)$' | xargs)
    if [ -n "$FILES" ]; then
      echo "🔍 Found changed TypeScript files, running related tests..."
      npx jest --findRelatedTests $FILES --passWithNoTests
    else
      echo "📝 No TypeScript files changed, skipping tests"
    fi
  else
    echo "📝 No TypeScript files changed, skipping tests"
  fi
else
  echo "🧪 Running full test suite for main branch..."
  pnpm test
fi

echo "✅ Pre-push checks completed!"