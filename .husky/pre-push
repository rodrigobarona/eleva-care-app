echo "🚀 Running pre-push checks..."

# Check if we're pushing to main or develop
branch=$(git branch --show-current)

if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
  echo "⚠️  Pushing to $branch - running full test suite..."
  
  # Run all critical tests before pushing to main/develop
  echo "🧪 Running unit tests..."
  pnpm test:unit --passWithNoTests
  
  echo "🪝 Running webhook tests..."
  pnpm test tests/api/webhooks/ --passWithNoTests
  
  echo "🔗 Running integration tests..."
  pnpm test:integration --passWithNoTests
  
  echo "🏗️ Testing build..."
  pnpm build
  
else
  echo "📦 Running focused tests for feature branch..."
  
  # For feature branches, run tests related to changed files
  changed_files=$(git diff origin/$branch..HEAD --name-only | grep -E '\.(ts|tsx)$' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
  
  if [ -n "$changed_files" ]; then
    echo "🔍 Found changed TypeScript files, running related tests..."
    pnpm test --findRelatedTests $changed_files --passWithNoTests
  else
    echo "📝 No TypeScript files changed, running basic test check..."
    pnpm test --passWithNoTests --testPathPattern="__tests__" || echo "ℹ️  No matching tests found"
  fi
fi

echo "✅ Pre-push checks completed!"