#!/usr/bin/env bash
set -euo pipefail

# Load nvm and node environment - critical for GitHub Desktop
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
fi

# Alternative: use system node if nvm not available
if ! command -v node >/dev/null 2>&1; then
  export PATH="/usr/local/bin:$PATH"
fi

echo "ğŸš€ Running pre-push checks..."

# Check if we're on a feature branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ $BRANCH == feat/* || $BRANCH == fix/* || $BRANCH == chore/* ]]; then
  echo "ğŸ“¦ Running critical tests for feature branch..."
  
  # Only run the important, up-to-date tests
  echo "ğŸ” Running critical API and webhook tests..."
  pnpm exec jest tests/api/create-payment-intent.test.ts tests/api/webhooks/ --passWithNoTests
  
  echo "âœ… Critical tests completed!"
else
  echo "ğŸ§ª Running full test suite for main branch..."
  pnpm test
fi

echo "âœ… Pre-push checks completed!"