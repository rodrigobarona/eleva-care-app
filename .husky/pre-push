#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing to main or develop
branch=$(git branch --show-current)

if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
  echo "âš ï¸  Pushing to $branch - running full test suite..."
  
  # Run all critical tests before pushing to main/develop
  echo "ğŸ§ª Running unit tests..."
  pnpm test:unit --passWithNoTests
  
  echo "ğŸª Running webhook tests..."
  pnpm test tests/api/webhooks/ --passWithNoTests
  
  echo "ğŸ”— Running integration tests..."
  pnpm test:integration --passWithNoTests
  
  echo "ğŸ—ï¸ Testing build..."
  pnpm build
  
else
  echo "ğŸ“¦ Running focused tests for feature branch..."
  
  # For feature branches, run tests related to changed files
  pnpm test --findRelatedTests --passWithNoTests $(git diff origin/$branch..HEAD --name-only | grep -E '\.(ts|tsx)$' | paste -sd ' ' || echo "")
fi

echo "âœ… Pre-push checks completed!" 