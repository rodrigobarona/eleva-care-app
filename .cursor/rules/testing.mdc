---
description: Testing Guidelines for Next.js 16 with Vitest and Playwright
globs: ['tests/**/*.{ts,tsx}', '**/*.test.{ts,tsx}', '**/*.spec.{ts,tsx}']
---

# Testing Guidelines for Next.js 16

## Testing Stack

- **Unit/Integration Tests**: Vitest
- **E2E Tests**: Playwright
- **Coverage**: @vitest/coverage-v8
- **Component Testing**: @testing-library/react

## Mock Next.js 16 APIs

```typescript
import { vi } from 'vitest';

// Always mock these first (before imports)
vi.mock('next/cache', () => ({
  revalidatePath: vi.fn(),
  revalidateTag: vi.fn(),
  updateTag: vi.fn(),
  refresh: vi.fn(),
  cacheTag: vi.fn(),
  cacheLife: vi.fn(),
}));

vi.mock('next/navigation', () => ({
  redirect: vi.fn().mockImplementation(() => {
    throw new Error('NEXT_REDIRECT');
  }),
}));

vi.mock('@workos-inc/authkit-nextjs', () => ({
  withAuth: vi.fn().mockResolvedValue({
    user: {
      id: 'user_123',
      email: 'test@example.com',
      firstName: 'Test',
      lastName: 'User',
    },
    sessionId: 'session_123',
  }),
}));
```

## Test Server Actions

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { serverAction } from '@/server/actions/posts';

describe('Server Action: createPost', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should invalidate cache tags', async () => {
    const { updateTag } = await import('next/cache');

    await serverAction({ title: 'Test' });

    expect(updateTag).toHaveBeenCalledWith('posts');
  });

  it('should handle redirects', async () => {
    const { redirect } = await import('next/navigation');

    await expect(serverAction({ title: 'Test' })).rejects.toThrow('NEXT_REDIRECT');
    expect(redirect).toHaveBeenCalledWith('/posts');
  });
});
```

## Test Components

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { MyComponent } from '@/components/MyComponent';

describe('MyComponent', () => {
  it('renders correctly', () => {
    render(<MyComponent />);
    expect(screen.getByRole('button')).toBeInTheDocument();
  });

  it('handles user interaction', async () => {
    const user = userEvent.setup();
    const handleClick = vi.fn();

    render(<MyComponent onClick={handleClick} />);

    await user.click(screen.getByRole('button'));

    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

## Test Async Params

```typescript
import { describe, it, expect } from 'vitest';

it('handles async params', async () => {
  const params = Promise.resolve({ id: 'test-123' });
  const result = await pageComponent({ params });
  expect(result).toBeDefined();
});
```

## Vitest vs Jest API Reference

| Jest | Vitest |
|------|--------|
| `jest.fn()` | `vi.fn()` |
| `jest.mock()` | `vi.mock()` |
| `jest.spyOn()` | `vi.spyOn()` |
| `jest.clearAllMocks()` | `vi.clearAllMocks()` |
| `jest.MockedFunction<T>` | `Mock<T>` |
| `jest.requireActual()` | `vi.importActual()` |

## E2E Testing with Playwright

```typescript
import { test, expect } from '@playwright/test';

test.describe('User Flow', () => {
  test('should complete booking flow', async ({ page }) => {
    await page.goto('/experts');
    
    // Wait for page to load
    await expect(page.locator('main')).toBeVisible();
    
    // Interact with elements
    await page.getByRole('button', { name: /book/i }).click();
    
    // Assert results
    await expect(page).toHaveURL(/book/);
  });
});
```

## Best Practices

1. **Import from vitest** - Use `import { vi, describe, it, expect } from 'vitest'`
2. **Clear mocks** - Use `beforeEach(() => vi.clearAllMocks())`
3. **Test behavior** - Test what users see, not implementation
4. **Use queries wisely:**
   - `getBy` - Element must exist
   - `queryBy` - Element might not exist
   - `findBy` - Wait for async element
5. **User interactions** - Use `@testing-library/user-event` not `fireEvent`
6. **Accessibility** - Query by role, label, placeholder, text

## Running Tests

```bash
# Run all unit tests
pnpm test

# Run tests in watch mode
pnpm test:watch

# Run with coverage
pnpm test:coverage

# Run E2E tests
pnpm test:e2e

# Run E2E with UI
pnpm test:e2e:ui
```

## Test File Organization

```
tests/
├── api/                    # API endpoint tests
│   ├── [route-name].test.ts
│   └── webhooks/
├── server/                 # Server action tests
│   └── actions/
├── components/             # Component tests
│   ├── atoms/
│   ├── molecules/
│   └── organisms/
├── integration/            # Integration tests
│   └── services/
├── e2e/                    # Playwright E2E tests
│   ├── auth.spec.ts
│   ├── booking.spec.ts
│   └── security.spec.ts
├── lib/                    # Utility function tests
├── __mocks__/              # Mock modules
└── setup.ts                # Vitest setup file
```
