---
description: Testing Guidelines for Next.js 16 with Vitest and Playwright
globs: ['tests/**/*.{ts,tsx}', '**/*.test.{ts,tsx}', '**/*.spec.{ts,tsx}']
---

# Testing Guidelines for Next.js 16

## Testing Stack

- **Unit/Integration Tests**: Vitest
- **E2E Tests**: Playwright
- **Coverage**: @vitest/coverage-v8
- **Component Testing**: @testing-library/react

## Mock Next.js 16 APIs

```typescript
import { vi } from 'vitest';

// Always mock these first (before imports)
vi.mock('next/cache', () => ({
  revalidatePath: vi.fn(),
  revalidateTag: vi.fn(),
  updateTag: vi.fn(),
  refresh: vi.fn(),
  cacheTag: vi.fn(),
  cacheLife: vi.fn(),
}));

vi.mock('next/navigation', () => ({
  redirect: vi.fn().mockImplementation(() => {
    throw new Error('NEXT_REDIRECT');
  }),
}));

vi.mock('@workos-inc/authkit-nextjs', () => ({
  withAuth: vi.fn().mockResolvedValue({
    user: {
      id: 'user_123',
      email: 'test@example.com',
      firstName: 'Test',
      lastName: 'User',
    },
    sessionId: 'session_123',
  }),
}));
```

## Test Server Actions

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { serverAction } from '@/server/actions/posts';

describe('Server Action: createPost', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should invalidate cache tags', async () => {
    const { updateTag } = await import('next/cache');

    await serverAction({ title: 'Test' });

    expect(updateTag).toHaveBeenCalledWith('posts');
  });

  it('should handle redirects', async () => {
    const { redirect } = await import('next/navigation');

    await expect(serverAction({ title: 'Test' })).rejects.toThrow('NEXT_REDIRECT');
    expect(redirect).toHaveBeenCalledWith('/posts');
  });
});
```

## Test Components

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { MyComponent } from '@/components/MyComponent';

describe('MyComponent', () => {
  it('renders correctly', () => {
    render(<MyComponent />);
    expect(screen.getByRole('button')).toBeInTheDocument();
  });

  it('handles user interaction', async () => {
    const user = userEvent.setup();
    const handleClick = vi.fn();

    render(<MyComponent onClick={handleClick} />);

    await user.click(screen.getByRole('button'));

    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

## Test Async Params

```typescript
import { describe, it, expect } from 'vitest';

it('handles async params', async () => {
  const params = Promise.resolve({ id: 'test-123' });
  const result = await pageComponent({ params });
  expect(result).toBeDefined();
});
```

## Vitest vs Jest API Reference

| Jest | Vitest |
|------|--------|
| `jest.fn()` | `vi.fn()` |
| `jest.mock()` | `vi.mock()` |
| `jest.spyOn()` | `vi.spyOn()` |
| `jest.clearAllMocks()` | `vi.clearAllMocks()` |
| `jest.MockedFunction<T>` | `Mock<T>` |
| `jest.requireActual()` | `vi.importActual()` |

## E2E Testing with Playwright

```typescript
import { test, expect } from '@playwright/test';

test.describe('User Flow', () => {
  test('should complete booking flow', async ({ page }) => {
    await page.goto('/experts');
    
    // Wait for page to load
    await expect(page.locator('main')).toBeVisible();
    
    // Interact with elements
    await page.getByRole('button', { name: /book/i }).click();
    
    // Assert results
    await expect(page).toHaveURL(/book/);
  });
});
```

## Critical: Use vi.hoisted() for Mocks

When using `vi.mock()` with factory functions, mocks are hoisted to the top of the file.
To reference variables in the factory, use `vi.hoisted()`:

```typescript
// ✅ CORRECT - mocks are hoisted before vi.mock()
const mocks = vi.hoisted(() => ({
  myFunction: vi.fn(),
  dbQuery: vi.fn(),
}));

vi.mock('@/lib/myModule', () => ({
  myFunction: mocks.myFunction,
}));

vi.mock('@/drizzle/db', () => ({
  db: { query: mocks.dbQuery },
}));

// Now import the module under test
import { myFunction } from '@/lib/myModule';

describe('myFunction', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mocks.myFunction.mockResolvedValue({ success: true });
  });
});
```

```typescript
// ❌ WRONG - will cause "Cannot access before initialization"
const myFunction = vi.fn();
vi.mock('@/lib/myModule', () => ({
  myFunction, // Error: myFunction is undefined when vi.mock runs
}));
```

## Mock Stripe (Default Export)

Stripe uses a default export constructor, so mock it correctly:

```typescript
vi.mock('stripe', () => ({
  default: vi.fn().mockImplementation(() => ({
    customers: {
      create: vi.fn().mockResolvedValue({ id: 'cus_mock' }),
      retrieve: vi.fn().mockResolvedValue({ id: 'cus_mock' }),
    },
    paymentIntents: {
      create: vi.fn().mockResolvedValue({ id: 'pi_mock' }),
    },
    checkout: {
      sessions: {
        create: vi.fn().mockResolvedValue({ url: 'https://checkout...' }),
      },
    },
  })),
}));
```

## Best Practices

1. **Import from vitest** - Use `import { vi, describe, it, expect } from 'vitest'`
2. **Use vi.hoisted()** - For mocks referenced in vi.mock() factories
3. **Clear mocks** - Use `beforeEach(() => vi.clearAllMocks())`
4. **Test behavior** - Test what users see, not implementation
5. **Use queries wisely:**
   - `getBy` - Element must exist
   - `queryBy` - Element might not exist
   - `findBy` - Wait for async element
6. **User interactions** - Use `@testing-library/user-event` not `fireEvent`
7. **Accessibility** - Query by role, label, placeholder, text
8. **Async handling** - Use `await act(async () => {})` for state updates

## Running Tests

```bash
# Run all unit tests
bun run test

# Run tests in watch mode
bun run test:watch

# Run with coverage
bun run test:coverage

# Run E2E tests
bun run test:e2e

# Run E2E with UI
bun run test:e2e:ui
```

## Test File Organization

```
tests/
├── api/                    # API endpoint tests
│   ├── [route-name].test.ts
│   └── webhooks/
├── server/                 # Server action tests
│   └── actions/
├── components/             # Component tests
│   ├── atoms/
│   ├── molecules/
│   └── organisms/
├── integration/            # Integration tests
│   └── services/
├── e2e/                    # Playwright E2E tests
│   ├── auth.spec.ts
│   ├── booking.spec.ts
│   └── security.spec.ts
├── lib/                    # Utility function tests
├── __mocks__/              # Mock modules
└── setup.ts                # Vitest setup file
```

## Related Agent Skills

When working on tests, consider invoking these skills:
- `playwright-e2e-testing` -- E2E test patterns, selectors, assertions, fixtures
- `agent-browser` -- browser automation for interactive testing and debugging
